module Assignment7 where
    
    import Lecture6
    import System.Random
    import Control.Monad

    {- Returns probably a prime of bitlenght n, and checking Primality with primeMR k -}
    probablePrime :: Int -> Int -> IO Integer
    probablePrime n k =  let
                          from = 2^(n-1)
                          to   = 2^n-1  
                        in do
                          p <- randomRIO (from,to)
                          if even p then probablePrime n k
                            else do
                              r <- primeMR k p
                              if r then return p else probablePrime n k
    
    {- Returns a tuple of probably primes of bitlength n, and checking for Primality with primMR k -}
    probablePrimePair :: Int -> Int -> IO (Integer, Integer)
    probablePrimePair n k = do
                            a <- probablePrime n k
                            b <- probablePrime n k
                            if a == b then probablePrimePair n k else return (a,b)

    {- 
     - Demonstrates RSA encryption and decription. The n is the bitlength of the primes used for the keys. k is the number of attempts for primeMR.
     - And m is the message (int) to encode. To not lose any data with the decoding, the message should be smaller than the two primes multiplied.
    -}
    rsaDemo :: Int -> Int -> Integer -> IO ()
    rsaDemo n k m = do
                        (p,q) <- probablePrimePair n k
                        publicKey <- return $ rsa_public p q
                        privateKey <- return $ rsa_private p q
                        encoded <- return $ rsa_encode publicKey m
                        decoded <- return $ rsa_decode privateKey encoded
                        when (p*q <= m) (putStrLn "Message is longer than the modulo, will lose data.\n") -- http://crypto.stackexchange.com/questions/11904/why-does-plain-rsa-not-work-with-big-messages-mn
                        putStrLn "Public key: "; putStrLn $ show publicKey; putStrLn ""
                        putStrLn "Private key:"; putStrLn $ show privateKey; putStrLn ""
                        putStrLn "Message to encode:"; putStrLn $ show m; putStrLn ""
                        putStrLn "Encoded message:"; putStrLn $ show encoded; putStrLn ""
                        putStrLn "Decoded message:"; putStrLn $ show decoded; putStrLn ""


    {-
     - Some demo of the rsaDemo function.
     - 
     - *Assignment7> rsaDemo 2048 3 123456789
     - Public key: 
     - (5,573188543296026042089781376719853958847771263798956123124951964546623859986754272093199382700444101330450508994492926332616215
     - 628594141762699957133496455197754844688084005341773371345851022388768194770801494662753713019966814098082540140370003320557487174
     - 557244426134943298310613620744429856131758968942432561889784310850542980791876079488750061652917539783971430301519492120944086419
     - 216054004096629002747796759487518287853243191126382438462683673126819898866830419247024883408018741722558727681754176554532147199
     - 995968281160250717997550599860949498970808052113365239827685636432254034484594105387642303914257970725355760727902339802998841487
     - 708314231393136386036061129388741048723918910232199376788766479693682334498306915824764518883258468074151614817515499146371688323
     - 637226256470660301861941109907225552217503812215582382616242544438870437295486531312993050062115084238714750078473773275882189753
     - 224589545557799311892689288364901070776966057341533917579076062961662104485356612556449412583587111638138490580240473577613123489
     - 146340294634328657484216681463968105513516937435813894167626073163305949273081597043845650719352979344689711865658035785354254760
     - 972079794272928532157268998759508123919271743480592317011601753977332569051)
     - 
     - Private key:
     - (22927541731841041683591255068794158353910850551958244924998078581864954399470170883727975308017764053218020359779717053304648625
     - 143765670507998285339858207910193787523360213670934853834040895550727790832059786510148520798672563923301605614800132822299486982
     - 289777045397731932424544829777194245270358757697302475591372434021719231675043179550002466116701591358857212060779684837763456768
     - 642160163865160109911870379500731514129727645055297538507346925072795954673216769880995336320749668902349107270167062181285887999
     - 838731246410028719902023994437979958832322084534609593107425457290161379383764215505692156570318829012304432467572504436387407575
     - 883742862120400978558732888827500498290965412792222741630415923598521719018535402816558766487573848783902340106776879739145931204
     - 164285064237851516840916760518029088777148099510234919714771513493939815592071752336642719708101684386954349545466935005435722625
     - 187665689854050783512227781443022446610887992051699194316172114791852466939524255898277309334753162790966254335009323776754238911
     - 248971127900717735059925697823925520687150050027077620776354644226107416041827037794956579345045046979368144629295375424135920304
     - 0430484026015873277074831769721503983998468204949154034639490626983433197,
     - 573188543296026042089781376719853958847771263798956123124951964546623859986754272093199382700444101330450508994492926332616215628
     - 594141762699957133496455197754844688084005341773371345851022388768194770801494662753713019966814098082540140370003320557487174557
     - 244426134943298310613620744429856131758968942432561889784310850542980791876079488750061652917539783971430301519492120944086419216
     - 054004096629002747796759487518287853243191126382438462683673126819898866830419247024883408018741722558727681754176554532147199995
     - 968281160250717997550599860949498970808052113365239827685636432254034484594105387642303914257970725355760727902339802998841487708
     - 314231393136386036061129388741048723918910232199376788766479693682334498306915824764518883258468074151614817515499146371688323637
     - 226256470660301861941109907225552217503812215582382616242544438870437295486531312993050062115084238714750078473773275882189753224
     - 589545557799311892689288364901070776966057341533917579076062961662104485356612556449412583587111638138490580240473577613123489146
     - 340294634328657484216681463968105513516937435813894167626073163305949273081597043845650719352979344689711865658035785354254760972
     - 079794272928532157268998759508123919271743480592317011601753977332569051)
     - 
     - Message to encode:
     - 123456789
     - 
     - Encoded message:
     - 28679718602997181072337614380936720482949
     - 
     - Decoded message:
     - 123456789
     -
     - 
     - *Assignment7> probablePrimePair 2048 1
     - (25025155347911068674167836996654639313149314586306375252973612814951846952397211313816325945810391673116657472775173497497936026
     -  03786991346132845804926117302574556953488750615183381897727666223597888337499234323662086372066224715744100053630072024781972194
     -  18074667622704290296944869981838409469288775027283701078748709496175805116882127777116036751356025581300009957074818300888774319
     -  44505077397527366251302284042874259457985187912959685119334877746434848825376858137478364079710264581322135977760481221832595098
     -  259225694923409093371580797880523110114029847689787006222160135783864112648634019034178679940049139992573,
     -  25136845449230564807347674708829870139982168910843910829937295886468166748983235458249716511647607743222350784982823747079136668
     -  08934725580557835274105177169998311224158717589230678689879206734778243229429395568060933148674704422148756417087893132437342617
     -  12981173323448742487272657724981880396989691148225885073791177793133680556326796780889089052690103684965421116183369198921370235
     -  10255378503054815539641934900301216728932945228369472416728770928513040897140196853685785391830759297059660884410458661839384632
     -  167895486473125997173529061635545914369413791316775406700967532791483088865161077050930593888783342475111)
     - (22.73 secs, 6,366,402,616 bytes)


     - *Assignment7> probablePrimePair 4096 1
     - (82179779585161253257292243198797049850881706878097089649088678182781315021385704508235922736589721759094522111286539857145428461
     -  70164139413281314613712942733438548914624510600725536255816445204291721139525868770009019585735360381240362009199682820869692272
     -  07928529086971808606747384872465516850890335588891897258765252128241081436997807716190337890681257902455133757740758334661146376
     -  40341211565017929145911022186527980048088021370841346736773127299037567846883190389283971826843696395797481102767982670844642043
     -  56973423031045447981289715530034099003023549951498415696099324633337191137242217482230307707570061958348064709621869607713942388
     -  97492310071861824626961480155688210946469838542992921076842531897446130638208505345507807566934923668653647686413579709698353981
     -  23984781893637147654762434442229744703459049478008091255639730740888407190754836074648601099244787255538566891624855087303548989
     -  81512179153976162788907829952414346351326886095892270496900162404231903919019816029351086076978954508925604967124915143393459246
     -  30270925655019537438567467945871244058546716623906746750152502276375565514775235341584622929132712917304435354535843466268112185
     -  645071339095607679983100768522540199567660841075544681856548446636381689744797991,
     -  96508033166270203277365087567730509262412423286281337943026674103422701259865910852318388221044611916227893376278233432188913807
     -  91462232555148591829921241886617476782796667806603016276911631615165013906393946963802581723326241153363890910187055957508732663
     -  06531093993062268272562038128260175583698783303855189154337176415856832812335847959146461353039805887378319436466622586897188282
     -  83179352857786410153072663131119758053827806747272897498507684812687550521819395176186057782520838094552286717759740210115964982
     -  13925465472049716677806751997568567028081766338996794648867941780794618093428890313999784625604801870959911179541827205355083341
     -  26488372452596835473429589892500428117551655399770474772182656965957020413076429328529717103990285095293241072391224923607985166
     -  50051657487001189575655258983624372893452007288843223023470687857648533913536091435144715417020683297982216812143965516317315141
     -  89572805431773061270265050491542306233807309583872403137238832366602567449240570641369277282044005511074333696699474161091946783
     -  62232407352705646706267713397765892947170705080384045596732372122407387500487038716693127744578834194813564643963423463099219735
     -  927865281390279194152563306292667351965985729734113908073363321753443726030366121)
     - (143.94 secs, 27,608,373,104 bytes)


     - *Assignment7> probablePrimePair 8192 1
     - (10153298682126817219448264411389125977901705011840441132129919590934990907385694748100525337364585335684158768122585572555014184
     -  79798743388823991370773155165205865153599915980535585748144426060257898487478192681428358143251220447609162626186723080521933263
     -  29375727915595187420541399910495586939557830567258307483704435618356428219284906201437784275587744388958954459823051021210801025
     -  39707018665037037657888892139113291506023709943187664991501658303346548711652576603769303514446330247600201255850447845012830937
     -  35681658784361177946791964916569270032916631573802280665719480788702439982973944577657779938155924626879182616295241208343541941
     -  87719666094026105216041099696971681681382133908671778103533668631069866272488065653722609534339259092989277796423174353833256617
     -  07305432391110896521756259320144883363733692118165694185991252677320086861393801323654883823845264041099609733351430240144194865
     -  14592300190822269416491479195261313279574860204598110884906135613828409792857511338193049892101906866596880499223365789972130707
     -  27982066523160403999437574326696628439957643360463856824022538606541573210455719500539042894559837838415700795437591527769784682
     -  72600730355948690246272083692675935846560596306945484521498308901966629949417887137028432149502357284383079423190519796870029000
     -  42088559780462582844504027123009999248323477188844652408805422274776233352499315465993802514952318125889781917343966724098791674
     -  87622764405081713828597565117837377257103456348812728029561856093262358507527338263220425900648422431179462471436575401196521495
     -  73905050176110668724017620686467063291253056339729220823843283458579517896573501931957540171277455434722870173955487389922420171
     -  72852379423862725250758003279926346184606688360249463823057873867135964722317904433233849277337908069851981100719264385573012988
     -  79010538405466809999534011338271241761528790216456454493075019352903068374340669617161872813954913089889058408678305658720556896
     -  01581542951121535188934989050759169158787097294943165799832827690002303254142909066213131820945238487742704389534288501185206579
     -  58762024594775808666907317546428196422644592913370262346111355781035764238229774967939334432179832638054022535628985918397422856
     -  67145192051154721132342369786657011245851876759779717298243116006166076164818632531681770000712609828029122284806132907411534338
     -  42441562918625947174467815199037185239531917001050045514686342042031476636954040199920423414775948725380540177214146432182838227
     -  10178456844270676200275117582279399,
     -  10216308111562221728178118513464311223452115444610905053937293096298529925193493566291103866873752016402528423300354854125000232
     -  81043065827572923416701428824129819443877240274776188159236932154366740037165769378267185976713452030534774483104103604171804960
     -  53991154169062762273261226543098496377452670424089293333347268398181302826106557882068912126591957625597553965398215951651907492
     -  92716880226721888348320636974959391129370160333207932589523384366910774143366493908607713880729776385367378150627919914531627288
     -  42883599473947216404674327570415309148936038328858272844083423403723366618218095652224686884897172173281074043543797408706265646
     -  59470160818941376115083239512628877937257748541751893177949453179709564263757884586331559582960558089950991827022369318300539237
     -  39501927807962766005495093300417117532355343480925922973242253551780006136765673540460129995765326348634789370464179964127686978
     -  59204916486667371821828113567035384369684042623332745521991395904066852818826231235632485201260771467866544961902493275242557845
     -  63137864929336060327335609121211995453178235187674100569932154475381088290159117782235769812086116716343152578866014889320016682
     -  47344533794527880519247242481102277254947475757212814981998930790095379060232808362853139418934656335689748904002731952661681824
     -  26222642283224233042981073048156595293396403638818437080284131506736179076998405437516053402952655647795892268617456785550124001
     -  42334275929884022807952741410526536041821600353310416428922909309847002477724242488532699899544404349287331485787270459501343596
     -  65355723932870114830140098638975141894298700198438759559748350155503577243282031317857344666888147841163324293533356490659245764
     -  31045859775131235678205373121201995770685996393453817640108566810742678413133456910188107491107756684050101510180813333453627077
     -  95868417252364105081921112402086875620308729410324639703824295708519389035442099087868931011622257918574366218727410922486971721
     -  33084508882484058803797117475282086514766154414854438166958474507359766557452894098581856906547241426333842266722966998348592077
     -  76613444790467381263494570764029031153318591257042902763133532131154043339723564366198895646683605947592962846806517429703126413
     -  66402428513923843771846389303212434655730427629349509659747659415074443208254099021177827295765399346086637048462532719185025672
     -  84937891060050551433517905807756194361420345176016479338783427428230190192963829544208801576271233164690072465642882073752231548
     -  15113137937316066318234488017966163)
     - (1927.16 secs, 193,303,101,520 bytes)

     -}